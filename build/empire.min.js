(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){(function(process){var Request=require("./request.js").Request;var Walkthrough=require("./walkthrough.js").Walkthrough;exports.Empire=function(appKey,opts){var self=this;function initialize(){if(!opts){opts={}}var apiServer=opts["apiServer"]||"api.empiredata.co";self.appKey=appKey;self.enduser=opts["enduser"];self.sessionKey="";var protocol=apiServer.indexOf("localhost")>-1?"http":"https";self.baseUrl=protocol+"://"+apiServer+"/empire/";self.serviceSecrets=null;if(opts["secrets"]){self.serviceSecrets=opts["secrets"]}}self.loadSecrets=function(file){if(typeof window==="undefined"){self.serviceSecrets=require(process.cwd()+"/"+file);return{ready:function(handler){handler()}}}else{return new Request(self,file,{local:true,customHandlers:{ready:function(handler,response){self.serviceSecrets=response;self.isReady=true;handler()}}})}};self.connect=function(service,secrets){if(!secrets){secrets={};for(k in self.serviceSecrets[service].option){v=self.serviceSecrets[service].option[k];secrets[k]=v.value}}return new Request(self,"services/"+service+"/connect",{method:"post",body:secrets})};self.describe=function(service,table){var path="services";if(service){path+="/"+service;if(table){path+="/"+table}}else if(table){throw new Error("Service must be specified if table is specified!")}return new Request(self,path)};self.printQuery=function(sql){self.query(sql).forEach(function(row){console.log(row)})};self.query=function(sql){return new Request(self,"query",{method:"post",body:{query:sql},raw:true,customHandlers:{forEach:function(handler,response){response.split("\n").forEach(function(row){if(row!=""){handler(JSON.parse(row))}})}}})};self.insert=function(service,table,row){return new Request(self,"services/"+service+"/"+table,{method:"post",body:row})};self.materializeView=function(name,sql){if(!self.enduser){throw new Error("Cannot use a materialized view within a session initiated without an enduser")}return new Request(self,"view/"+name,{method:"put",body:{query:sql},customHandlers:{ready:function(handler){waitUntilViewIsReady(name,handler,100)}}})};self.dropView=function(name){if(!self.enduser){throw new Error("Cannot use a materialized view within a session initiated without an enduser")}return new Request(self,"view/"+name,{method:"delete"})};self.viewMaterializedAt=function(name){if(!self.enduser){throw new Error("Cannot use a materialized view within a session initiated without an enduser")}return new Request(self,"view/"+name+"/status",{filter:function(response){try{return new Date(response["materializedAt"])}catch(e){return null}}})};self.walkthrough=function(){new Walkthrough(self).run()};function waitUntilViewIsReady(name,callback,interval){new Request(self,"view/"+name+"/status").success(function(result){if(result["viewStatus"]=="ready"){callback()}else if(result["viewStatus"]=="pending"){setTimeout(function(){waitUntilViewIsReady(name,callback,interval)},interval)}})}initialize()};if(typeof window!=="undefined"){window.Empire=exports.Empire}}).call(this,require("_process"))},{"./request.js":2,"./walkthrough.js":3,_process:4}],2:[function(require,module,exports){if(typeof window==="undefined"){var r=require;var HttpRequest=r("xmlhttprequest").XMLHttpRequest}else{var HttpRequest=XMLHttpRequest}function extend(a,b){for(var key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a}exports.simpleHttpRequest=function(opts){var request=new HttpRequest;request.open(opts.method,opts.url,true);for(header in opts.headers){request.setRequestHeader(header,opts.headers[header])}request.send(JSON.stringify(opts.body||{}));request.onreadystatechange=function(){if(request.readyState==4){if(request.status==200)opts.success(request.responseText);else{if(opts.failure){opts.failure(request.status,request.responseText)}}}}};exports.Request=function(empire,path,opts){if(!opts){opts={}}var self=this;var successHandler=function(){};this.success=function(handler){successHandler=handler;return this};var errorHandler=function(e){throw new Error(e.body)};this.error=function(handler){errorHandler=handler;return this};var customHandlers={};if(opts.customHandlers){for(event in opts.customHandlers){this[event]=function(handler){customHandlers[event]=handler;return self}}}function withSessionKey(callback){if(empire.sessionKey){callback();return}exports.simpleHttpRequest({url:empire.baseUrl+"session/create"+(empire.enduser?"?enduser="+empire.enduser:""),method:"post",headers:{Authorization:'Empire appkey="'+empire.appKey+'"'},body:{},success:function(responseText){response=JSON.parse(responseText);if(response["sessionkey"]){empire.sessionKey=response["sessionkey"];callback()}else if(response.status=="error"){throwError("request",200,responseText)}},failure:function(status,responseText){throwError("request",status,responseText)}})}function doRequest(){var defaultHeaders={Authorization:'Empire sessionkey="'+empire.sessionKey+'"',"Content-Type":"application/json",Accept:"*/*"};exports.simpleHttpRequest({url:(opts.local?"":empire.baseUrl)+path,method:opts.method||"get",headers:extend(defaultHeaders,opts.headers||{}),body:opts.body||{},success:function(responseText){if(opts.raw){var response=responseText}else{try{var response=JSON.parse(responseText)}catch(e){throwError("json",200,responseText,e.message);return}}if(response.status=="error"){throwError("request",200,responseText);return}if(opts.filter){response=opts.filter(response)}if(opts.customHandlers){for(eventName in customHandlers){var event=opts.customHandlers[eventName];var handler=customHandlers[eventName];event(handler,response)}}successHandler(response)},failure:function(status,responseText){throwError("request",status,responseText)}})}function throwError(type,statusCode,response,body){if(!body){try{var body=JSON.parse(response).error}catch(err){var body=response}}errorHandler({type:type,statusCode:statusCode,body:body,response:response})}withSessionKey(doRequest)}},{}],3:[function(require,module,exports){exports.Walkthrough=function(empire){var service=null;var table=null;this.run=function(){if(!empire.serviceSecrets){console.log("Please connect some services in https://login.empiredata.co, and download the new JSON file");return}var services=Object.keys(empire.serviceSecrets);walkthroughServices(services,function(){walkthroughMaterializedView(service,table)})};function walkthroughServices(services,callback){service=services.shift();console.log("empire.connect('"+service+"');");empire.connect(service).success(function(){empire.describe(service).success(function(result){var tables=result.service.tables.map(function(tableData){return tableData.table});if(service=="mailchimp"){tables=tables.filter(function(t){return t!="list_member"&&t!="campaign"&&t!="campaign_sent_to"&&t!="campaign_opened"})}walkthroughTables(service,tables,function(){if(services.length>0){walkthroughServices(services,callback)}else{callback()}})})})}function walkthroughTables(service,tables,callback){table=tables.shift();console.log("empire.query('SELECT * FROM "+service+"."+table+" LIMIT 5');");empire.query("SELECT * FROM "+service+"."+table+" LIMIT 5").forEach(printRow).success(function(){if(tables.length>0){walkthroughTables(service,tables,callback)}else{callback()}})}function walkthroughMaterializedView(service,table){if(!empire.enduser){console.log("Please specify an enduser parameter when instantiating the client, so that you can try materialized views");return}console.log("empire.materializeView('viewName', 'SELECT * FROM "+service+"."+table+" LIMIT 5').ready( function() {\n  empire.query('SELECT * FROM viewName LIMIT 5');\n});");empire.materializeView("viewName","SELECT * FROM "+service+"."+table+" LIMIT 5").ready(function(){empire.query("SELECT * FROM viewName LIMIT 5").forEach(printRow).success(function(){console.log("empire.dropView('viewName');");empire.dropView("viewName")})})}function printRow(row){var maxLength=70;var fragment=JSON.stringify(row).slice(0,maxLength);if(fragment.length==maxLength){fragment+="..."}console.log("   "+fragment)}}},{}],4:[function(require,module,exports){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}if(canPost){var queue=[];window.addEventListener("message",function(ev){var source=ev.source;if((source===window||source===null)&&ev.data==="process-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("process-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}]},{},[1]);